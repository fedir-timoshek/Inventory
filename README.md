# Inventory Web App (GitHub Pages + Apps Script API)

This repo hosts a static frontend on GitHub Pages and uses a Google Apps Script Web App as the API.

## Repository layout
- `web/` - frontend source (HTML/CSS/JS).
- `web/modules/` - JS modules imported by `web/app.js`.
- `web/assets/` - static assets (optional).
- `scripts/build.mjs` - build script that bundles and minifies the frontend into `web/dist/`.
- `web/dist/` - build output (generated; not committed).
- `appscript/` - Apps Script backend (`code.gs`).
- `appscript/reference/InventoryDB.xlsx` - reference spreadsheet (not used at runtime).

## Spreadsheet schema (Inventory tab)
The backend expects the Inventory sheet columns in this exact order:

| Column | Name       | Notes |
|--------|------------|-------|
| A      | ID         | UUID generated by the API |
| B      | Timestamp  | Auto-filled by the API |
| C      | Barcode    | Required |
| D      | Room       | Required |
| E      | Quantity   | Default 1 |
| F      | Notes      | Optional |
| G      | Image URL  | Auto-filled when image is uploaded |
| H      | User Email | Auto-filled from Google ID token |
| I      | Deleted    | TRUE/FALSE (soft delete) |

Other tabs:
- `Rooms` - list of rooms in column A (from row 2).
- `History` - audit log (auto-written by the API).

## Backend setup (Apps Script)
1) Open your Google Sheet and make sure it has the tabs: `Inventory`, `Rooms`, `History`.
2) Insert the `Quantity` column between `Room` and `Notes` (column E). This shifts Notes to F, Image URL to G, User Email to H, Deleted to I.
3) Fill column E (`Quantity`) with `1` for existing rows.
4) Open Apps Script and replace the project code with `appscript/code.gs`.
5) Update the constants at the top of `appscript/code.gs`:
   - `INVENTORY_SPREADSHEET_ID`
   - `IMAGE_FOLDER_ID`
   - `TIMEZONE`
   - `GOOGLE_CLIENT_ID`
   - `ADMIN_EMAILS`
6) Deploy the Apps Script as a Web App:
   - Deploy -> New deployment -> Web app
   - Execute as: Me
   - Who has access: Anyone
   - Copy the Web App URL
7) If you change Apps Script code later, deploy a new version.

## OAuth setup (Google Cloud)
1) Create an OAuth Client ID (Web application).
2) Add Authorized JavaScript origins:
   - `https://<your-username>.github.io`
   - Add your custom domain if you use one
3) Copy the Client ID for the frontend.

## Frontend setup
1) Update `web/index.html` meta tags:
   - `meta[name="api-url"]` -> Apps Script Web App URL
   - `meta[name="google-client-id"]` -> OAuth Client ID

## Deploy to GitHub Pages (recommended)
1) In GitHub: Settings -> Pages -> Source: **GitHub Actions**.
2) The workflow builds and deploys `web/dist` on every push to `main`.
3) No need to commit `web/dist` manually.

## Build locally (optional)
```bash
npm install
npm run build
```
- This generates `web/dist` with bundled/minified `app.min.js` and `styles.min.css`.
- If you add a `package-lock.json`, you can switch to `npm ci` and enable npm caching in the workflow.

## Local development
Open the app via a local server (not via `file://`), otherwise module scripts will fail.
```bash
cd web
python3 -m http.server
```
Then open `http://localhost:8000`.

## Behavior overview
- Non-admin users see only their own entries.
- Admins see all entries and can edit/delete.
- Offline queue stores unsent entries and syncs when back online.

## Troubleshooting
- **Entries missing:** non-admins only see their own entries. Check `User Email` values in the sheet.
- **Quantity not saving:** verify the Inventory column order matches the schema above.
- **Login fails:** check `api-url`, OAuth Client ID, and Apps Script deployment.
- **Camera/torch issues:** HTTPS is required for camera access. Torch support depends on the device.
- **Nothing works locally:** use a local server (`python3 -m http.server`).

## Notes
- The API validates Google ID tokens server-side.
- If you redeploy Apps Script, update the Web App URL in `web/index.html`.
